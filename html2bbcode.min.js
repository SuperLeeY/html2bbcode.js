!function(t,e){"undefined"!=typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&"object"==typeof define.amd?define(e):this[t]=e()}("html2bbcode",function(t){"use strict";function e(){this.name="",this.length=0}function n(){this.stack=[],this.length=0}function i(){this.s="",this.weaknewline=!1,this.stack=[]}function s(t){this.opts=t?t:{}}t={version:"1.0.9"},e.headingtags=["h1","h2","h3","h4","h5","h6"],e.selfendtags=["!doctype","meta","link","img","br"],e.newlinetags=["div","p","br","li"].concat(e.headingtags),e.noemptytags=["head","style","script","span","a","font","color","size","face","strong","b","em","i","del","s","ins","u"],e.prototype.findquoteend=function(t,e){var n=-1,i=e,s=t.length,r='"'===t[i];for(i++;s>i;)if("\\"===t[i])switch(i++,t[i]){case"u":i+=5;break;case"x":i+=3;break;default:i++}else{if(r&&'"'===t[i]||!r&&"'"===t[i]){n=i;break}if("\n"===t[i])break;i++}return n},e.prototype.quote=function(t){if("'"===t[0]){for(var e='"',n=1,i=t.length-1,s=n;i>n;)if("\\"===t[n])switch(n++,t[n]){case"u":n+=5;break;case"x":n+=3;break;default:n++}else{if('"'===t[n]){e+=t.substr(s,n-s),e+='\\"',n++,s=n;break}n++}return i>s&&(e+=t.substr(s,i-s)),e+='"'}return t},e.prototype.parseStyle=function(t){for(var e=t.split(";"),n={},i=0,s=0;s<e.length;s++){var r=e[s].split(":");r.length>=2&&(i++,n[r[0].trim().toLowerCase()]=r[1].trim())}return i>0?n:void 0},e.prototype.parseAttributes=function(t){t=t.trim();for(var e=/\s/,n=0,i=t.length,s=n,r=null,o=!1,a={},c=function(t,e){"undefined"==typeof e&&(e=null),t=t.trim().toLowerCase(),a[t]=e};i>n;){if("="===t[n])r=t.substr(s,n-s),o=!1;else if(e.test(t[n]))r&&o?(c(r,t.substr(s,n-s)),o=!1,r=null):n-s>0&&(r=t.substr(s,n-s),c(r),r=null),s=n+1;else if(r&&!o)if(s=n,'"'===t[n]||"'"===t[n]){var f="'"===t[n];if(n=this.findquoteend(t,n),-1===n)break;var l=t.substr(s,n+1-s);f&&(l=this.quote(l));try{l=JSON.parse(l)}catch(h){}c(r,l),r=null,s=n+1}else o=!0;n++}if(i>s){var p=t.substr(s);r?c(r,p):c(p),r=null}var u=0;for(var g in a)u++;u>0&&(a.style&&(a.style=this.parseStyle(a.style)),this.attr=a)},e.prototype.parse=function(t){var i=0;if("<"!==t[i])throw new Error("not a tag");for(var s=t.length,r=/\s/;s>i;)if("<"===t[i])i++;else{if(">"===t[i])return this.length=i+1,this;if(!r.test(t[i]))break;i++}if(i>=s)return this.length=i,this;for(var o=i,a=!1;s>i&&!r.test(t[i]);){if(">"===t[i]){a=!0;break}if("/"===t[i])break;i++}if(i>=s)return this.length=i,this;if(this.name=t.substr(o,i-o).trim().toLowerCase(),this.name.length>0&&"/"===this.name[0])return this.length=i,this.name=this.name.substr(1),this.selfend=!0,this;if(e.selfendtags.indexOf(this.name)>=0&&(this.selfend=!0),!a){for(o=i;s>i&&">"!==t[i];)i++;if(i>=s)return this.length=i,this;if(i-o>0){var c=t.substr(o,i-o).trim(),f=c.length;f>0&&"/"===c[f-1]&&(this.selfend=!0,c=c.substr(0,f-1)),this.parseAttributes(c)}}if(i++,this.selfend)return this.length=i,this;for(var l=this,h=function(t){var e=(new n).parse(t);return l.content?l.content.append(e):l.content=e,e.length},p=0;s>i;){for(p++,o=i;s>i&&r.test(t[i]);)i++;for(;s>i&&"<"!==t[i];)i++;var u=i;for(i++;s>i&&r.test(t[i]);)i++;if(i>=s)return this.content=(new n).parse(t.substr(o)),this.length=s,this;if(s>i&&"/"===t[i]){for(i++;s>i&&r.test(t[i]);)i++;if(i>=s)return i+=h(t.substr(o)),this.length=s,this;for(var g=i,d=!1;s>i&&!r.test(t[i]);){if(">"===t[i]){d=!0;break}i++}if(i>g){if(!d)for(;s>i&&">"!==t[i];)i++;i++;t.substr(g,i-g).trim().toLowerCase();return this.length=i,u>o&&h(t.substr(o,u-o)),this}}i=o+h(t.substr(o))}return this.length=this.content.length,this},n.prototype.parse=function(t){if(!t)return this;for(var n=0,i=t.length,s=0,r=/\s/,o=this,a=function(e,n){n>e&&o.push(t.substr(e,n-e))};i>n;)switch(t[n]){case"<":a(s,n);for(var c=n+1;i>c&&r.test(t[c]);)c++;if(i>c&&"/"===t[c])return this;var f=(new e).parse(t.substr(n));this.push(f),n+=f.length,s=n;break;case">":n++;break;default:n++}return a(s,i),this},n.prototype.push=function(t){this.length+=t.length,this.stack.push(t)},n.prototype.pop=function(){return this.stack.pop()},n.prototype.append=function(t){this.stack=this.stack.concat(t.stack),this.length+=t.length},n.prototype.stack=function(){return this.stack};var r={nbsp:" ",amp:"&",lt:"<",gt:">",quot:'"'};return n.unescape=function(t,e){var n="&([a-zA-Z]+?|#[xX][\\da-fA-F]+?|#\\d+?);",i=new RegExp(n),s=function(t,n){if(n=n.toLowerCase(),e&&"nbsp"===n)return"&nbsp;";var i=r[n];if(i)return i;if("#"===n[0]){var s=0;if(s="x"==n[1]?parseInt(n.substr(2),16):parseInt(n.substr(1)))return String.fromCharCode(s)}return""};if(i.test(t)){var o=new RegExp(n,"g");t=t.replace(o,s)}return t},n.prototype.decode=function(t){for(var i=0;i<this.stack.length;i++){var s=this.stack[i];"string"==typeof s?this.stack[i]=n.unescape(s,t):s instanceof e&&s.content&&s.content.decode(t)}return this},n.prototype.strip=function(t,n){for(var n=t&&!n?e.newlinetags.indexOf(t.name)>=0:!0,i=0;i<this.stack.length;i++){var s=this.stack[i];if(s instanceof e&&s.content){var r;if(0>=i)r=n;else for(var o=i-1;o>=0;o--){var a=this.stack[o];if(a instanceof e){r=e.newlinetags.indexOf(a.name)>=0;break}if(a)break}s.content.strip(s,r)}}for(var c=/^\s*$/,f=[],l=0,h=!0,i=0;i<this.stack.length;i++){var s=this.stack[i];if("string"==typeof s&&c.test(s)){if(h)continue;n=!1}else if(s instanceof e){if(h=!0,e.noemptytags.indexOf(s.name)>=0&&!s.content)continue;n=e.newlinetags.indexOf(s.name)>=0?!0:!1}else{if(n&&(s=s.replace(/^\s+/g,""),!s))continue;s=s.replace(/\s+/g," "),h=!1,n=!1}l++,f.push(s)}return 0>=l&&t?void delete t.content:(this.stack=f,this)},n.prototype.showtree=function(t,n){t||(t=""),n||(n=0);for(var i=0;i<this.stack.length;i++){var s=this.stack[i];s instanceof e?(console.log(t,s.name,s.attr?JSON.stringify(s.attr):""),s.content&&s.content.showtree(t+"--",n+1)):"string"==typeof s&&console.log(t,JSON.stringify(s))}},i.maps={a:{section:"url",attr:"href"},img:{section:"img",data:"src",empty:!0},em:{section:"i"},i:{section:"i"},strong:{section:"b"},b:{section:"b"},del:{section:"s"},s:{section:"s"},ins:{section:"u"},u:{section:"u"},center:{section:"center"},ul:{section:"ul"},ol:{section:"ol"},li:{section:"li",newline:1},blockquote:{section:"quote"},code:{section:"code"},pre:{section:"code"},font:{extend:["color","face","size"]},span:{extend:["color","face","size"]},color:{section:"color",attr:"color"},size:{section:"size",attr:"size"},face:{section:"font",attr:"face"},div:{newline:0},h1:{section:"h1",newline:1},h2:{section:"h2",newline:1},h3:{section:"h3",newline:1},h4:{section:"h4",newline:1},h5:{section:"h5",newline:1},h6:{section:"h6",newline:1},p:{newline:1},br:{newline:2},table:{newline:1},tr:{newline:0},"!doctype":{ignore:!0},head:{ignore:!0},style:{ignore:!0},script:{ignore:!0},meta:{ignore:!0},link:{ignore:!0}},i.prototype.open=function(t,e,n){t&&(t instanceof Array?this.stack=this.stack.concat(t):this.stack.push({section:t,attr:e,data:n}))},i.prototype.append=function(t){this.solidify(),this._append(t)},i.prototype._append=function(t){t&&(this.s+=t,this.weaknewline=!1)},i.prototype.solidify=function(){var t;for(t=0;t<this.stack.length;t++){var e=this.stack[t],n=e.section,i=e.attr,s=e.data,r="["+n;if("string"==typeof i)r+="="+i;else for(var o in i)r+=" "+o+"="+i[o];r+="]",s&&(r+=s),this._append(r)}t>0&&(this.stack=[])},i.prototype.close=function(t){t&&(this.solidify(),this._append("[/"+t+"]"))},i.prototype.rollback=function(){this.stack=[]},i.prototype.newline=function(t){if(2===t)this.s+="\n",this.weaknewline=!0;else if(1===t){if(!this.s)return;this.weaknewline||(this.s+="\n",this.weaknewline=!0)}else this.weaknewline||(this.s+="\n",this.weaknewline=!0)},i.prototype.toString=function(){return this.s},s.prototype.color=function(t){if(t){var e=/rgba?\s*?\(\s*?(\d{1,3})\s*?,\s*?(\d{1,3})\s*?,\s*?(\d{1,3})\s*?.*?\)/i;if(e.test(t)){var n=function(t){return t.length<2&&(t="0"+t),t};t=t.replace(e,function(t,e,i,s){return e=n(parseInt(e).toString(16)),i=n(parseInt(i).toString(16)),s=n(parseInt(s).toString(16)),"#"+e+i+s})}return t}},s.prototype.size=function(t){if(t){var e=[0,12,14,16,18,24,32,48],n=[null,"smaller","small","medium","large","x-large","xx-large","-webkit-xxx-large"];if(/^\d+$/.test(t))return t;if(/^\d+?px$/.test(t)){if(t=parseInt(t),t&&!(0>t)){if(!this.opts.transsize)return t.toString();for(var i=e.length;i>=0;i--){if(0===i)return"1";if(t>=e[i])return i.toString()}return t?t.toString():void 0}}else{var s=n.indexOf(t);if(s>0)return this.opts.transsize?s.toString():e[s].toString()}}},s.prototype.px=function(t){return t?(t=parseInt(t),t?t.toString():void 0):void 0},s.prototype.convertStyle=function(t,e){if(e){var n=[],s=this,r=this.opts,o=function(e){if(e&&!e.ignore&&(e.section||e.extend&&e.extend.length>0)){var i={section:e.section};if(e.attr){if(!t.attr)return;switch(e.section){case"size":i.attr=s.size(t.attr[e.attr]);break;case"color":i.attr=s.color(t.attr[e.attr]);break;default:i.attr=t.attr[e.attr]}if(t.attr.style){var o;switch(e.section){case"size":o=t.attr.style["font-size"],o&&(o=s.size(o));break;case"color":o=t.attr.style.color,o&&(o=s.color(o));break;case"face":o=t.attr.style["font-face"]}o&&(i.attr=o)}if(!i.attr)return}else if("img"===e.section&&r.imagescale){var a,c;if(t.attr){if(a=s.px(t.attr.width),c=s.px(t.attr.height),t.attr.style){var f,l;f=s.px(t.attr.style.width),l=s.px(t.attr.style.height),f&&(a=f),l&&(c=l)}a&&c?i.attr=a+"x"+c:(a||c)&&(a?i.attr={width:a}:i.attr={height:c})}}e.data&&(i.data=t.attr[e.data]),n.push(i)}};if(t.attr&&t.attr.style){if("b"!==t.name&&"strong"!==t.name){var a=t.attr.style["font-weight"];("bold"===a||/^\d+$/.test(a)&&parseInt(a)>=700)&&o(i.maps.b)}if("center"!==t.name){var a=t.attr.style["text-align"];"center"!==a||r.noalign||o(i.maps.center)}}if("list"===e.section||"ul"===e.section||"ol"===e.section||"li"===e.section){if(r.nolist)return[]}else if("center"===e.section){if(r.noalign)return[]}else if(/^h\d+$/.test(e.section)&&r.noheadings){var c=[null,"32px","24px","19px","16px","14px","12px"],f=e.section.match(/^h(\d+)$/),l=parseInt(f[1]);return 0>=l?[]:(l>=c.length&&(l=c.length),n.push({section:"size",attr:s.size(c[l])}),n)}if("extend"in e)for(var h=0;h<e.extend.length;h++){var p=e.extend[h];o(i.maps[p])}else o(e);return n}},s.prototype.convert=function(t){var n=new i;if(!t)return n;var s=this,r=function(t){for(var o=0;o<t.length;o++){var a=t[o];if(a instanceof e)if(a.name in i.maps){var c=!1,f=i.maps[a.name];if(f.ignore)continue;if("newline"in f&&(c=f.newline,n.newline(f.newline)),!a.content&&!f.empty)continue;var l=s.convertStyle(a,f);n.open(l),a.content&&r(a.content.stack);for(var h=l.length-1;h>=0;h--)n.close(l[h].section);c&&n.newline()}else a.content&&r(a.content.stack);else"string"==typeof a&&(a=a.replace(/&nbsp;/gi," "),n.append(a))}};return r(t.stack),n},s.prototype.parse=function(t){return(new n).parse(t).strip().decode(!0)},s.prototype.feed=function(t){var e=this.parse(t),n=this.convert(e);return n},{HTMLTag:e,HTMLStack:n,BBCode:i,HTML2BBCode:s}});
