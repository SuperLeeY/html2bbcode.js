!function(t,e){"undefined"!=typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&"object"==typeof define.amd?define(e):this[t]=e()}("html2bbcode",function(t){"use strict";function e(){this.name="",this.length=0}function n(){this.stack=[],this.length=0}function i(){this.s="",this.weaknewline=!1}function r(t){this.opts=t?t:{}}t={version:"1.0.8"},e.selfendtags=["!doctype","meta","link","img","br"],e.newlinetags=["div","p","br"],e.noemptytags=["head","style","script","span","font","color","size","face","strong","b","em","i","del","s","ins","u"],e.prototype.findquoteend=function(t,e){var n=-1,i=e,r=t.length,s='"'===t[i];for(i++;r>i;)if("\\"===t[i])switch(i++,t[i]){case"u":i+=5;break;case"x":i+=3;break;default:i++}else{if(s&&'"'===t[i]||!s&&"'"===t[i]){n=i;break}if("\n"===t[i])break;i++}return n},e.prototype.quote=function(t){if("'"===t[0]){for(var e='"',n=1,i=t.length-1,r=n;i>n;)if("\\"===t[n])switch(n++,t[n]){case"u":n+=5;break;case"x":n+=3;break;default:n++}else{if('"'===t[n]){e+=t.substr(r,n-r),e+='\\"',n++,r=n;break}n++}return i>r&&(e+=t.substr(r,i-r)),e+='"'}return t},e.prototype.parseStyle=function(t){for(var e=t.split(";"),n={},i=0,r=0;r<e.length;r++){var s=e[r].split(":");s.length>=2&&(i++,n[s[0].trim().toLowerCase()]=s[1].trim())}return i>0?n:void 0},e.prototype.parseAttributes=function(t){t=t.trim();for(var e=/\s/,n=0,i=t.length,r=n,s=null,o=!1,a={},f=function(t,e){"undefined"==typeof e&&(e=null),t=t.trim().toLowerCase(),a[t]=e};i>n;){if("="===t[n])s=t.substr(r,n-r),o=!1;else if(e.test(t[n]))s&&o?(f(s,t.substr(r,n-r)),o=!1,s=null):n-r>0&&(s=t.substr(r,n-r),f(s),s=null),r=n+1;else if(s&&!o)if(r=n,'"'===t[n]||"'"===t[n]){var c="'"===t[n];if(n=this.findquoteend(t,n),-1===n)break;var l=t.substr(r,n+1-r);c&&(l=this.quote(l));try{l=JSON.parse(l)}catch(h){}f(s,l),s=null,r=n+1}else o=!0;n++}if(i>r){var p=t.substr(r);s?f(s,p):f(p),s=null}var u=0;for(var g in a)u++;u>0&&(a.style&&(a.style=this.parseStyle(a.style)),this.attr=a)},e.prototype.parse=function(t){var i=0;if("<"!==t[i])throw new Error("not a tag");for(var r=t.length,s=/\s/;r>i;)if("<"===t[i])i++;else{if(">"===t[i])return this.length=i+1,this;if(!s.test(t[i]))break;i++}if(i>=r)return this.length=i,this;for(var o=i,a=!1;r>i&&!s.test(t[i]);){if(">"===t[i]){a=!0;break}if("/"===t[i])break;i++}if(i>=r)return this.length=i,this;if(this.name=t.substr(o,i-o).trim().toLowerCase(),this.name.length>0&&"/"===this.name[0])return this.length=i,this.name=this.name.substr(1),this.selfend=!0,this;if(e.selfendtags.indexOf(this.name)>=0&&(this.selfend=!0),!a){for(o=i;r>i&&">"!==t[i];)i++;if(i>=r)return this.length=i,this;if(i-o>0){var f=t.substr(o,i-o).trim(),c=f.length;c>0&&"/"===f[c-1]&&(this.selfend=!0,f=f.substr(0,c-1)),this.parseAttributes(f)}}if(i++,this.selfend)return this.length=i,this;for(var l=this,h=function(t){var e=(new n).parse(t);return l.content?l.content.append(e):l.content=e,e.length},p=0;r>i;){for(p++,o=i;r>i&&s.test(t[i]);)i++;for(;r>i&&"<"!==t[i];)i++;var u=i;for(i++;r>i&&s.test(t[i]);)i++;if(i>=r)return this.content=(new n).parse(t.substr(o)),this.length=r,this;if(r>i&&"/"===t[i]){for(i++;r>i&&s.test(t[i]);)i++;if(i>=r)return i+=h(t.substr(o)),this.length=r,this;for(var g=i,d=!1;r>i&&!s.test(t[i]);){if(">"===t[i]){d=!0;break}i++}if(i>g){if(!d)for(;r>i&&">"!==t[i];)i++;i++;t.substr(g,i-g).trim().toLowerCase();return this.length=i,u>o&&h(t.substr(o,u-o)),this}}i=o+h(t.substr(o))}return this.length=this.content.length,this},n.prototype.parse=function(t){if(!t)return this;for(var n=0,i=t.length,r=0,s=/\s/,o=this,a=function(e,n){n>e&&o.push(t.substr(e,n-e))};i>n;)switch(t[n]){case"<":a(r,n);for(var f=n+1;i>f&&s.test(t[f]);)f++;if(i>f&&"/"===t[f])return this;var c=(new e).parse(t.substr(n));this.push(c),n+=c.length,r=n;break;case">":n++;break;default:n++}return a(r,i),this},n.prototype.push=function(t){this.length+=t.length,this.stack.push(t)},n.prototype.pop=function(){return this.stack.pop()},n.prototype.append=function(t){this.stack=this.stack.concat(t.stack),this.length+=t.length},n.prototype.stack=function(){return this.stack};var s={nbsp:" ",amp:"&",lt:"<",gt:">",quot:'"'};return n.unescape=function(t,e){var n="&([a-zA-Z]+?|#[xX][\\da-fA-F]+?|#\\d+?);",i=new RegExp(n),r=function(t,n){if(n=n.toLowerCase(),e&&"nbsp"===n)return"&nbsp;";var i=s[n];if(i)return i;if("#"===n[0]){var r=0;if(r="x"==n[1]?parseInt(n.substr(2),16):parseInt(n.substr(1)))return String.fromCharCode(r)}return""};if(i.test(t)){var o=new RegExp(n,"g");t=t.replace(o,r)}return t},n.prototype.decode=function(t){for(var i=0;i<this.stack.length;i++){var r=this.stack[i];"string"==typeof r?this.stack[i]=n.unescape(r,t):r instanceof e&&r.content&&r.content.decode(t)}return this},n.prototype.strip=function(t,n){for(var n=t&&!n?e.newlinetags.indexOf(t.name)>=0:!0,i=0;i<this.stack.length;i++){var r=this.stack[i];if(r instanceof e&&r.content){var s;if(0>=i)s=n;else for(var o=i-1;o>=0;o--){var a=this.stack[o];if(a instanceof e){s=e.newlinetags.indexOf(a.name)>=0;break}if(a)break}r.content.strip(r,s)}}for(var f=/^\s*$/,c=[],l=0,h=!0,i=0;i<this.stack.length;i++){var r=this.stack[i];if("string"==typeof r&&f.test(r)){if(h)continue;n=!1}else if(r instanceof e){if(h=!0,e.noemptytags.indexOf(r.name)>=0&&!r.content)continue;n=e.newlinetags.indexOf(r.name)>=0?!0:!1}else n&&(r=r.replace(/^\s+/g,"")),r=r.replace(/\s+/g," "),h=!1,n=!1;l++,c.push(r)}return 0>=l&&t?void delete t.content:(this.stack=c,this)},n.prototype.showtree=function(t,n){t||(t=""),n||(n=0);for(var i=0;i<this.stack.length;i++){var r=this.stack[i];r instanceof e?(console.log(t,r.name,r.attr?JSON.stringify(r.attr):""),r.content&&r.content.showtree(t+"--",n+1)):"string"==typeof r&&console.log(t,JSON.stringify(r))}},i.maps={a:{section:"url",attr:"href"},img:{section:"img",data:"src"},em:{section:"i"},i:{section:"i"},strong:{section:"b"},b:{section:"b"},del:{section:"s"},s:{section:"s"},ins:{section:"u"},u:{section:"u"},center:{section:"center"},ul:{section:"ul"},ol:{section:"ol"},li:{section:"li",newline:1},blockquote:{section:"quote"},code:{section:"code"},pre:{section:"code"},font:{extend:["color","face","size"]},span:{extend:["color","face","size"]},color:{section:"color",attr:"color"},size:{section:"size",attr:"size"},face:{section:"font",attr:"face"},div:{newline:0},h1:{section:"h1",newline:1},h2:{section:"h2",newline:1},h3:{section:"h3",newline:1},h4:{section:"h4",newline:1},h5:{section:"h5",newline:1},h6:{section:"h6",newline:1},p:{newline:1},br:{newline:2},table:{newline:1},tr:{newline:0},"!doctype":{ignore:!0},head:{ignore:!0},style:{ignore:!0},script:{ignore:!0},meta:{ignore:!0},link:{ignore:!0}},i.prototype.open=function(t,e,n){if(t){var i="["+t;if("string"==typeof e)i+="="+e;else for(var r in e)i+=" "+r+"="+e[r];i+="]",n&&(i+=n),this.append(i)}},i.prototype.append=function(t){t&&(this.s+=t,this.weaknewline=!1)},i.prototype.close=function(t){t&&this.append("[/"+t+"]")},i.prototype.newline=function(t){if(2===t)this.s+="\n",this.weaknewline=!0;else if(1===t){if(!this.s)return;this.weaknewline||(this.s+="\n",this.weaknewline=!0)}else this.weaknewline||(this.s+="\n",this.weaknewline=!0)},i.prototype.toString=function(){return this.s},r.prototype.color=function(t){if(t){var e=/rgba?\s*?\(\s*?(\d{1,3})\s*?,\s*?(\d{1,3})\s*?,\s*?(\d{1,3})\s*?.*?\)/i;if(e.test(t)){var n=function(t){return t.length<2&&(t="0"+t),t};t=t.replace(e,function(t,e,i,r){return e=n(parseInt(e).toString(16)),i=n(parseInt(i).toString(16)),r=n(parseInt(r).toString(16)),"#"+e+i+r})}return t}},r.prototype.size=function(t){if(t){var e=[0,12,14,16,18,24,32,48],n=[null,"smaller","small","medium","large","x-large","xx-large","-webkit-xxx-large"];if(/^\d+$/.test(t))return t;if(/^\d+?px$/.test(t)){if(t=parseInt(t),t&&!(0>t)){if(!this.opts.transsize)return t.toString();for(var i=e.length;i>=0;i--){if(0===i)return"1";if(t>=e[i])return i.toString()}return t?t.toString():void 0}}else{var r=n.indexOf(t);if(r>0)return this.opts.transsize?r.toString():e[r].toString()}}},r.prototype.px=function(t){return t?(t=parseInt(t),t?t.toString():void 0):void 0},r.prototype.convertStyle=function(t,e){if(e){var n=[],r=this,s=this.opts,o=function(e){if(e&&!e.ignore&&(e.section||e.extend&&e.extend.length>0)){var i={section:e.section};if(e.attr){if(!t.attr)return;switch(e.section){case"size":i.attr=r.size(t.attr[e.attr]);break;case"color":i.attr=r.color(t.attr[e.attr]);break;default:i.attr=t.attr[e.attr]}if(t.attr.style){var o;switch(e.section){case"size":o=t.attr.style["font-size"],o&&(o=r.size(o));break;case"color":o=t.attr.style.color,o&&(o=r.color(o));break;case"face":o=t.attr.style["font-face"]}o&&(i.attr=o)}if(!i.attr)return}else if("img"===e.section&&s.imagescale){var a,f;if(t.attr){if(a=r.px(t.attr.width),f=r.px(t.attr.height),t.attr.style){var c,l;c=r.px(t.attr.style.width),l=r.px(t.attr.style.height),c&&(a=c),l&&(f=l)}a&&f?i.attr=a+"x"+f:(a||f)&&(a?i.attr={width:a}:i.attr={height:f})}}e.data&&(i.data=t.attr[e.data]),n.push(i)}};if(t.attr&&t.attr.style){if("b"!==t.name&&"strong"!==t.name){var a=t.attr.style["font-weight"];("bold"===a||/^\d+$/.test(a)&&parseInt(a)>=700)&&o(i.maps.b)}if("center"!==t.name){var a=t.attr.style["text-align"];"center"!==a||s.noalign||o(i.maps.center)}}if("list"===e.section||"ul"===e.section||"ol"===e.section||"li"===e.section){if(s.nolist)return[]}else if("center"===e.section){if(s.noalign)return[]}else if(/^h\d+$/.test(e.section)&&s.noheadings){var f=[null,"32px","24px","19px","16px","14px","12px"],c=e.section.match(/^h(\d+)$/),l=parseInt(c[1]);return 0>=l?[]:(l>=f.length&&(l=f.length),n.push({section:"size",attr:r.size(f[l])}),n)}if("extend"in e)for(var h=0;h<e.extend.length;h++){var p=e.extend[h];o(i.maps[p])}else o(e);return n}},r.prototype.convert=function(t){var n=new i;if(!t)return n;var r=this,s=function(t){for(var o=0;o<t.length;o++){var a=t[o];if(a instanceof e)if(a.name in i.maps){var f=!1,c=i.maps[a.name];if(c.ignore)continue;"newline"in c&&(f=c.newline,n.newline(c.newline));for(var l=r.convertStyle(a,c),h=0;h<l.length;h++)n.open(l[h].section,l[h].attr,l[h].data);a.content&&s(a.content.stack);for(var h=l.length-1;h>=0;h--)n.close(l[h].section);f&&n.newline()}else a.content&&s(a.content.stack);else"string"==typeof a&&(a=a.replace(/&nbsp;/gi," "),n.append(a))}};return s(t.stack),n},r.prototype.parse=function(t){return(new n).parse(t).strip().decode(!0)},r.prototype.feed=function(t){var e=this.parse(t),n=this.convert(e);return n},{HTMLTag:e,HTMLStack:n,BBCode:i,HTML2BBCode:r}});
