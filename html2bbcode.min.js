!function(t,e){"undefined"!=typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&"object"==typeof define.amd?define(e):this[t]=e()}("html2bbcode",function(t){"use strict";function e(){this.name="",this.length=0}function n(){this.stack=[],this.length=0}function i(){this.s="",this.weaknewline=!0,this.stack=[]}function s(t){this.opts=t?t:{}}t={version:"1.2.1"},e.headingtags=["h1","h2","h3","h4","h5","h6"],e.selfendtags=["!doctype","meta","link","img","br"],e.newlinetags=["div","p","br","li","tr"].concat(e.headingtags),e.noemptytags=["head","style","script","span","a","font","color","size","face","strong","b","em","i","del","s","ins","u"],e.prototype.findquoteend=function(t,e,n){var i=-1,s=e?e:0,r=t.length,o='"'===t[s];for(s++;r>s;)if("\\"===t[s])switch(s++,t[s]){case"u":s+=5;break;case"x":s+=3;break;default:s++}else{if(o&&'"'===t[s]||!o&&"'"===t[s]){i=s;break}if("\n"===t[s]&&!n)break;s++}return i},e.prototype.findscriptend=function(t,e){for(var n=-1,i=e?e:0,s=t.length,r=/(['"]|<\s*?\/\s*?script\s*?>)/gi;s>i;)if('"'===t[i]||"'"===t[i]){var o=this.findquoteend(t,i,!0);if(-1===o)break;i=o+1}else{r.lastIndex=i;var a=r.exec(t);if(!a||a.length<=0)break;if("<"===a[0][0]){n=r.lastIndex-a[0].length;break}i=r.lastIndex-1}return n},e.prototype.quote=function(t){if("'"===t[0]){for(var e='"',n=1,i=t.length-1,s=n;i>n;)if("\\"===t[n])switch(n++,t[n]){case"u":n+=5;break;case"x":n+=3;break;default:n++}else{if('"'===t[n]){e+=t.substr(s,n-s),e+='\\"',n++,s=n;break}n++}return i>s&&(e+=t.substr(s,i-s)),e+='"'}return t},e.prototype.parseStyle=function(t){for(var e=t.split(";"),n={},i=0,s=0;s<e.length;s++){var r=e[s].split(":");r.length>=2&&(i++,n[r[0].trim().toLowerCase()]=r[1].trim())}return i>0?n:void 0},e.prototype.parseAttributes=function(t){t=t.trim();for(var e=/\s/,n=0,i=t.length,s=n,r=null,o=!1,a={},c=function(t,e){"undefined"==typeof e&&(e=null),t=t.trim().toLowerCase(),a[t]=e};i>n;){if("="===t[n])r=t.substr(s,n-s),o=!1;else if(e.test(t[n]))r&&o?(c(r,t.substr(s,n-s)),o=!1,r=null):n-s>0&&(r=t.substr(s,n-s),c(r),r=null),s=n+1;else if(r&&!o)if(s=n,'"'===t[n]||"'"===t[n]){var f="'"===t[n];if(n=this.findquoteend(t,n),-1===n)break;var h=t.substr(s,n+1-s);f&&(h=this.quote(h));try{h=JSON.parse(h)}catch(l){}c(r,h),r=null,s=n+1}else o=!0;n++}if(i>s){var p=t.substr(s);r?c(r,p):c(p),r=null}var u=0;for(var d in a)u++;u>0&&(a.style&&(a.style=this.parseStyle(a.style)),this.attr=a)},e.prototype.parse=function(t){var i=0;if("<"!==t[i])throw new Error("not a tag");for(var s=t.length,r=/\s/;s>i;)if("<"===t[i])i++;else{if(">"===t[i])return this.length=i+1,this;if(!r.test(t[i]))break;i++}if(i>=s)return this.length=s,this;for(var o=i,a=!1;s>i&&!r.test(t[i]);){if(">"===t[i]){a=!0;break}if("/"===t[i])break;i++}if(i>=s)return this.length=i,this;if(this.name=t.substr(o,i-o).trim().toLowerCase(),this.name.length>0&&"/"===this.name[0])return this.length=i,this.name=this.name.substr(1),this.selfend=!0,this;if(e.selfendtags.indexOf(this.name)>=0&&(this.selfend=!0),!a){for(o=i;s>i&&">"!==t[i];)i++;if(i>=s)return this.length=i,this;if(i-o>0){var c=t.substr(o,i-o).trim(),f=c.length;f>0&&"/"===c[f-1]&&(this.selfend=!0,c=c.substr(0,f-1)),this.parseAttributes(c)}}if(i++,this.selfend)return this.length=i,this;var h=this,l=function(t){var e=(new n).parse(t);return h.content?h.content.append(e):h.content=e,e.length};if("script"===this.name){var p=this.findscriptend(t.substr(i));if(0>p)return this.length=s,this;this.content=new n;var u=t.substr(i,p);return this.content.length=p,this.content.stack=[u],i+=p,o=t.indexOf(">",i),0>o?(this.length=s,this):(this.length=o+1,this)}for(var d=0;s>i;){for(d++,o=i;s>i&&r.test(t[i]);)i++;for(;s>i&&"<"!==t[i];)i++;var g=i;for(i++;s>i&&r.test(t[i]);)i++;if(i>=s)return this.content=(new n).parse(t.substr(o)),this.length=s,this;if(s>i&&"/"===t[i]){for(i++;s>i&&r.test(t[i]);)i++;if(i>=s)return i+=l(t.substr(o)),this.length=s,this;for(var v=i,y=!1;s>i&&!r.test(t[i]);){if(">"===t[i]){y=!0;break}i++}if(i>v){if(!y)for(;s>i&&">"!==t[i];)i++;t.substr(v,i-v).trim().toLowerCase();return i++,this.length=i,g>o&&l(t.substr(o,g-o)),this}}i=o+l(t.substr(o))}return this.length=i,this},n.prototype.parse=function(t){if(!t)return this;for(var n=0,i=t.length,s=0,r=/\s/,o=this,a=function(e,n){n>e&&o.push(t.substr(e,n-e))};i>n;)switch(t[n]){case"<":a(s,n);for(var c=n+1;i>c&&r.test(t[c]);)c++;if(i>c&&"/"===t[c])return this;var f=(new e).parse(t.substr(n));this.push(f),n+=f.length,s=n;break;case">":n++;break;default:n++}return a(s,i),this},n.prototype.push=function(t){this.length+=t.length,this.stack.push(t)},n.prototype.pop=function(){return this.stack.pop()},n.prototype.append=function(t){this.stack=this.stack.concat(t.stack),this.length+=t.length};var r={nbsp:" ",amp:"&",lt:"<",gt:">",quot:'"'};return n.unescape=function(t,e){var n="&([a-zA-Z]+?|#[xX][\\da-fA-F]+?|#\\d+?);",i=new RegExp(n),s=function(t,n){if(n=n.toLowerCase(),e&&"nbsp"===n)return"&nbsp;";var i=r[n];if(i)return i;if("#"===n[0]){var s=0;if(s="x"==n[1]?parseInt(n.substr(2),16):parseInt(n.substr(1)))return String.fromCharCode(s)}return""};if(i.test(t)){var o=new RegExp(n,"g");t=t.replace(o,s)}return t},n.prototype.decode=function(t){for(var i=0;i<this.stack.length;i++){var s=this.stack[i];"string"==typeof s?this.stack[i]=n.unescape(s,t):s instanceof e&&s.content&&s.content.decode(t)}return this},n.prototype.dedup=function(){for(var t=["div","span"],n=0;n<this.stack.length;n++){var i=this.stack[n];if(i instanceof e&&i.content){if(t.indexOf(i.name)>=0&&!i.attr&&1===i.content.stack.length){var s=i.content.stack[0];if(s.name===i.name){this.stack[n]=s,n--;continue}}i.content.dedup()}}return this},n.prototype.strip=function(t,n){n||(n=t&&!n?e.newlinetags.indexOf(t.name)>=0:!0);for(var i=/^\s*$/,s=0,r=!0,o=0;o<this.stack.length;o++){var a=this.stack[o];if(a instanceof e){if(r=!0,a.content){var c;if(0>=s)c=n;else{c=!1;for(var f=o-1;f>=0;f--){var h=this.stack[f];if(h instanceof e){c=e.newlinetags.indexOf(h.name)>=0;break}if("string"!=typeof h||!i.test(h))break}}a.content.strip(a,c)}}else if("string"==typeof a&&i.test(a)&&r)continue;s++}r=!0;for(var l=[],p=0,o=0;o<this.stack.length;o++){var a=this.stack[o];if("string"==typeof a&&i.test(a)&&n){if(r)continue;n=!1}else if(a instanceof e){if(r=!0,e.noemptytags.indexOf(a.name)>=0&&!a.content)continue;n=e.newlinetags.indexOf(a.name)>=0?!0:!1}else{if(n&&(a=a.replace(/^\s+/g,""),!a))continue;a=a.replace(/\s+/g," "),r=!1,n=!1}p++,l.push(a)}var a=l[p-1];return"string"==typeof a&&(p>=2&&i.test(a)?(l.splice(p-1,1),p--):/\S\s+$/.test(a)&&(l[p-1]=a.replace(/\s+$/,""))),0>=p&&t?void delete t.content:(this.stack=l,this)},n.prototype.showtree=function(t,n){t||(t=""),n||(n=0);for(var i=0;i<this.stack.length;i++){var s=this.stack[i];s instanceof e?(console.log(t,s.name,s.attr?JSON.stringify(s.attr):""),s.content&&s.content.showtree(t+"--",n+1)):"string"==typeof s&&console.log(t,JSON.stringify(s))}},i.maps={a:{section:"url",attr:"href"},img:{section:"img",data:"src",empty:!0},em:{section:"i"},i:{section:"i"},strong:{section:"b"},b:{section:"b"},del:{section:"s"},s:{section:"s"},ins:{section:"u"},u:{section:"u"},center:{section:"center"},ul:{section:"ul"},ol:{section:"ol"},li:{section:"li",newline:1},blockquote:{section:"quote"},code:{section:"code"},pre:{section:"code"},font:{extend:["color","face","size"]},span:{extend:["color","face","size"]},color:{section:"color",attr:"color"},size:{section:"size",attr:"size"},face:{section:"font",attr:"face"},h1:{section:"h1",newline:1},h2:{section:"h2",newline:1},h3:{section:"h3",newline:1},h4:{section:"h4",newline:1},h5:{section:"h5",newline:1},h6:{section:"h6",newline:1},p:{newline:1},br:{newline:2,empty:!0},table:{newline:1},tr:{newline:1},div:{newline:0},"!doctype":{ignore:!0},head:{ignore:!0},style:{ignore:!0},script:{ignore:!0},meta:{ignore:!0},link:{ignore:!0}},i.prototype.open=function(t,e,n){t&&(t instanceof Array?this.stack=this.stack.concat(t):this.stack.push({section:t,attr:e,data:n}))},i.prototype.append=function(t){this.solidify(),this._append(t)},i.prototype._append=function(t){t&&(this.s+=t,this.weaknewline=!1)},i.prototype.solidify=function(){var t;for(t=0;t<this.stack.length;t++){var e=this.stack[t],n=e.section,i=e.attr,s=e.data,r="["+n;if("string"==typeof i)r+="="+i;else for(var o in i)r+=" "+o+"="+i[o];r+="]",s&&(r+=s),this._append(r)}t>0&&(this.stack=[])},i.prototype.close=function(t){t&&(this.solidify(),this._append("[/"+t+"]"))},i.prototype.rollback=function(){this.stack=[]},i.prototype.newline=function(t){2===t?(this.append("\n"),this.weaknewline=!0):1===t?this.weaknewline||(this.append("\n"),this.weaknewline=!0):this.weaknewline||(this.append("\n"),this.weaknewline=!0)},i.prototype.toString=function(){return this.s},s.prototype.color=function(t){if(t){var e=/rgba?\s*?\(\s*?(\d{1,3})\s*?,\s*?(\d{1,3})\s*?,\s*?(\d{1,3})\s*?.*?\)/i;if(e.test(t)){var n=function(t){return t.length<2&&(t="0"+t),t};t=t.replace(e,function(t,e,i,s){return e=n(parseInt(e).toString(16)),i=n(parseInt(i).toString(16)),s=n(parseInt(s).toString(16)),"#"+e+i+s})}return t}},s.prototype.size=function(t){if(t){var e=[0,12,14,16,18,24,32,48],n=[null,"smaller","small","medium","large","x-large","xx-large","-webkit-xxx-large"];if(/^\d+$/.test(t))return t;if(/^\d+?px$/.test(t)){if(t=parseInt(t),t&&!(0>t)){if(!this.opts.transsize)return t.toString();for(var i=e.length;i>=0;i--){if(0===i)return"1";if(t>=e[i])return i.toString()}return t?t.toString():void 0}}else{var s=n.indexOf(t);if(s>0)return this.opts.transsize?s.toString():e[s].toString()}}},s.prototype.px=function(t){return t?(t=parseInt(t),t?t.toString():void 0):void 0},s.prototype.convertStyle=function(t,e){if(e){var n=[],s=this,r=this.opts,o=function(e){if(e&&!e.ignore&&(e.section||e.extend&&e.extend.length>0)){var i={section:e.section};if(e.attr){if(!t.attr)return;switch(e.section){case"size":i.attr=s.size(t.attr[e.attr]);break;case"color":i.attr=s.color(t.attr[e.attr]);break;default:i.attr=t.attr[e.attr]}if(t.attr.style){var o;switch(e.section){case"size":o=t.attr.style["font-size"],o&&(o=s.size(o));break;case"color":o=t.attr.style.color,o&&(o=s.color(o));break;case"face":o=t.attr.style["font-face"]}o&&(i.attr=o)}if(!i.attr)return}else if("img"===e.section&&r.imagescale){var a,c;if(t.attr){if(a=s.px(t.attr.width),c=s.px(t.attr.height),t.attr.style){var f,h;f=s.px(t.attr.style.width),h=s.px(t.attr.style.height),f&&(a=f),h&&(c=h)}a&&c?i.attr=a+"x"+c:(a||c)&&(a?i.attr={width:a}:i.attr={height:c})}}e.data&&(i.data=t.attr[e.data]),n.push(i)}};if(t.attr&&t.attr.style){if("b"!==t.name&&"strong"!==t.name){var a=t.attr.style["font-weight"];("bold"===a||/^\d+$/.test(a)&&parseInt(a)>=700)&&o(i.maps.b)}if("center"!==t.name){var a=t.attr.style["text-align"];"center"!==a||r.noalign||o(i.maps.center)}}if("list"===e.section||"ul"===e.section||"ol"===e.section||"li"===e.section){if(r.nolist)return[]}else if("center"===e.section){if(r.noalign)return[]}else if(/^h\d+$/.test(e.section)&&r.noheadings){var c=[null,"32px","24px","19px","16px","14px","12px"],f=e.section.match(/^h(\d+)$/),h=parseInt(f[1]);return 0>=h?[]:(h>=c.length&&(h=c.length),n.push({section:"size",attr:s.size(c[h])}),n)}if("extend"in e)for(var l=0;l<e.extend.length;l++){var p=e.extend[l];o(i.maps[p])}else o(e);return n}},s.prototype.convert=function(t){var n=new i;if(!t)return n;var s=this,r=function(t,o){for(var a=0;a<t.length;a++){var c=t[a];if(c instanceof e)if(c.name in i.maps){var f=0,h=i.maps[c.name];if(h.ignore)continue;if("newline"in h&&(f=h.newline,n.newline(h.newline)),!c.content&&!h.empty)continue;var l=s.convertStyle(c,h);n.open(l),c.content&&r(c.content.stack,f);for(var p=l.length-1;p>=0;p--)n.close(l[p].section);f&&n.newline()}else c.content&&r(c.content.stack);else"string"==typeof c&&n.append(c)}};return r(t.stack),n},s.prototype.parse=function(t){return(new n).parse(t).strip().dedup().decode()},s.prototype.feed=function(t){var e=this.parse(t);this.opts.debug&&e.showtree();var n=this.convert(e);return n},{HTMLTag:e,HTMLStack:n,BBCode:i,HTML2BBCode:s}});
