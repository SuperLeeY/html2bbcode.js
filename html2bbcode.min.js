!function(t,e){"undefined"!=typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&"object"==typeof define.amd?define(e):this[t]=e()}("html2bbcode",function(t){"use strict";function e(){this.name="",this.length=0}function n(){this.stack=[],this.length=0}function r(){this.s="",this.weaknewline=!1}function i(t){this.opts=t?t:{}}t={version:"1.0.5"},e.selfendtags=["!doctype","meta","link","img","br"],e.newlinetags=["div","p","br"],e.noemptytags=["head","style","script","span","font","color","size","face","strong","b","em","i","del","s","ins","u"],e.prototype.findquoteend=function(t,e){var n=-1,r=e,i=t.length,s='"'===t[r];for(r++;i>r;)if("\\"===t[r])switch(r++,t[r]){case"u":r+=5;break;case"x":r+=3;break;default:r++}else{if(s&&'"'===t[r]||!s&&"'"===t[r]){n=r;break}if("\n"===t[r])break;r++}return n},e.prototype.quote=function(t){if("'"===t[0]){for(var e='"',n=1,r=t.length-1,i=n;r>n;)if("\\"===t[n])switch(n++,t[n]){case"u":n+=5;break;case"x":n+=3;break;default:n++}else{if('"'===t[n]){e+=t.substr(i,n-i),e+='\\"',n++,i=n;break}n++}return r>i&&(e+=t.substr(i,r-i)),e+='"'}return t},e.prototype.parseStyle=function(t){for(var e=t.split(";"),n={},r=0,i=0;i<e.length;i++){var s=e[i].split(":");s.length>=2&&(r++,n[s[0].trim().toLowerCase()]=s[1].trim())}return r>0?n:void 0},e.prototype.parseAttributes=function(t){t=t.trim();for(var e=/\s/,n=0,r=t.length,i=n,s=null,o=!1,a={},f=function(t,e){"undefined"==typeof e&&(e=null),t=t.trim().toLowerCase(),a[t]=e};r>n;){if("="===t[n])s=t.substr(i,n-i),o=!1;else if(e.test(t[n]))s&&o?(f(s,t.substr(i,n-i)),o=!1,s=null):n-i>0&&(s=t.substr(i,n-i),f(s),s=null),i=n+1;else if(s&&!o)if(i=n,'"'===t[n]||"'"===t[n]){var c="'"===t[n];if(n=this.findquoteend(t,n),-1===n)break;var l=t.substr(i,n+1-i);c&&(l=this.quote(l));try{l=JSON.parse(l)}catch(h){}f(s,l),s=null,i=n+1}else o=!0;n++}if(r>i){var u=t.substr(i);s?f(s,u):f(u),s=null}var p=0;for(var g in a)p++;p>0&&(a.style&&(a.style=this.parseStyle(a.style)),this.attr=a)},e.prototype.parse=function(t){var r=0;if("<"!==t[r])throw new Error("not a tag");for(var i=t.length,s=/\s/;i>r;)if("<"===t[r])r++;else{if(">"===t[r])return this.length=r+1,this;if(!s.test(t[r]))break;r++}if(r>=i)return this.length=r,this;for(var o=r,a=!1;i>r&&!s.test(t[r]);){if(">"===t[r]){a=!0;break}if("/"===t[r])break;r++}if(r>=i)return this.length=r,this;if(this.name=t.substr(o,r-o).trim().toLowerCase(),this.name.length>0&&"/"===this.name[0])return this.length=r,this.name=this.name.substr(1),this.selfend=!0,this;if(e.selfendtags.indexOf(this.name)>=0&&(this.selfend=!0),!a){for(o=r;i>r&&">"!==t[r];)r++;if(r>=i)return this.length=r,this;if(r-o>0){var f=t.substr(o,r-o).trim(),c=f.length;c>0&&"/"===f[c-1]&&(this.selfend=!0,f=f.substr(0,c-1)),this.parseAttributes(f)}}if(r++,this.selfend)return this.length=r,this;for(var l=this,h=function(t){var e=(new n).parse(t);return l.content?l.content.append(e):l.content=e,e.length},u=0;i>r;){for(u++,o=r;i>r&&s.test(t[r]);)r++;for(;i>r&&"<"!==t[r];)r++;var p=r;for(r++;i>r&&s.test(t[r]);)r++;if(r>=i)return this.content=(new n).parse(t.substr(o)),this.length=i,this;if(i>r&&"/"===t[r]){for(r++;i>r&&s.test(t[r]);)r++;if(r>=i)return r+=h(t.substr(o)),this.length=i,this;for(var g=r,d=!1;i>r&&!s.test(t[r]);){if(">"===t[r]){d=!0;break}r++}if(r>g){if(!d)for(;i>r&&">"!==t[r];)r++;r++;t.substr(g,r-g).trim().toLowerCase();return this.length=r,p>o&&h(t.substr(o,p-o)),this}}r=o+h(t.substr(o))}return this.length=this.content.length,this},n.prototype.parse=function(t){if(!t)return this;for(var n=0,r=t.length,i=0,s=/\s/,o=this,a=function(e,n){n>e&&o.push(t.substr(e,n-e))};r>n;)switch(t[n]){case"<":a(i,n);for(var f=n+1;r>f&&s.test(t[f]);)f++;if(r>f&&"/"===t[f])return this;var c=(new e).parse(t.substr(n));this.push(c),n+=c.length,i=n;break;case">":n++;break;default:n++}return a(i,r),this},n.prototype.push=function(t){this.length+=t.length,this.stack.push(t)},n.prototype.pop=function(){return this.stack.pop()},n.prototype.append=function(t){this.stack=this.stack.concat(t.stack),this.length+=t.length},n.prototype.stack=function(){return this.stack};var s={nbsp:" ",amp:"&",lt:"<",gt:">",quot:'"'};return n.unescape=function(t,e){var n="&([a-zA-Z]+?|#[xX][\\da-fA-F]+?|#\\d+?);",r=new RegExp(n),i=function(t,n){if(n=n.toLowerCase(),e&&"nbsp"===n)return"&nbsp;";var r=s[n];if(r)return r;if("#"===n[0]){var i=0;if(i="x"==n[1]?parseInt(n.substr(2),16):parseInt(n.substr(1)))return String.fromCharCode(i)}return""};if(r.test(t)){var o=new RegExp(n,"g");t=t.replace(o,i)}return t},n.prototype.decode=function(t){for(var r=0;r<this.stack.length;r++){var i=this.stack[r];"string"==typeof i?this.stack[r]=n.unescape(i,t):i instanceof e&&i.content&&i.content.decode(t)}return this},n.prototype.strip=function(t,n){for(var n=t&&!n?e.newlinetags.indexOf(t.name)>=0:!0,r=0;r<this.stack.length;r++){var i=this.stack[r];i instanceof e&&i.content&&i.content.strip(i,0===r&&n)}for(var s=/^\s*$/,o=[],a=0,f=!0,r=0;r<this.stack.length;r++){var i=this.stack[r];if("string"==typeof i&&s.test(i)){if(f)continue;n=!1}else if(i instanceof e){if(f=!0,e.noemptytags.indexOf(i.name)>=0&&!i.content)continue;n=e.newlinetags.indexOf(i.name)>=0?!0:!1}else n&&(i=i.replace(/^\s+/g,"")),i=i.replace(/\s+/g," "),f=!1,n=!1;a++,o.push(i)}return 0>=a&&t?void delete t.content:(this.stack=o,this)},n.prototype.showtree=function(t,n){t||(t=""),n||(n=0);for(var r=0;r<this.stack.length;r++){var i=this.stack[r];i instanceof e?(console.log(t,i.name,i.attr?JSON.stringify(i.attr):""),i.content&&i.content.showtree(t+"--",n+1)):"string"==typeof i&&console.log(t,JSON.stringify(i))}},r.maps={a:{section:"url",attr:"href"},img:{section:"img",data:"src"},em:{section:"i"},i:{section:"i"},strong:{section:"b"},b:{section:"b"},del:{section:"s"},s:{section:"s"},ins:{section:"u"},u:{section:"u"},center:{section:"center"},ul:{section:"list"},ol:{section:"list"},li:{section:"li",newline:1},blockquote:{section:"quote"},code:{section:"code"},pre:{section:"code"},font:{extend:["color","face","size"]},span:{extend:["color","face","size"]},color:{section:"color",attr:"color"},size:{section:"size",attr:"size"},face:{section:"font",attr:"face"},div:{newline:0},h1:{section:"h1",newline:1},h2:{section:"h2",newline:1},h3:{section:"h3",newline:1},p:{newline:1},br:{newline:2},table:{newline:1},tr:{newline:0},"!doctype":{ignore:!0},head:{ignore:!0},style:{ignore:!0},script:{ignore:!0},meta:{ignore:!0},link:{ignore:!0}},r.prototype.open=function(t,e,n){if(t){var r="["+t;if("string"==typeof e)r+="="+e;else for(var i in e)r+=" "+i+"="+e[i];r+="]",n&&(r+=n),this.append(r)}},r.prototype.append=function(t){t&&(this.s+=t,this.weaknewline=!1)},r.prototype.close=function(t){t&&this.append("[/"+t+"]")},r.prototype.newline=function(t){if(2===t)this.s+="\n",this.weaknewline=!0;else if(1===t){if(!this.s)return;this.weaknewline||(this.s+="\n",this.weaknewline=!0)}else this.weaknewline||(this.s+="\n",this.weaknewline=!0)},r.prototype.toString=function(){return this.s},i.prototype.color=function(t){if(t){var e=/rgba?\s*?\(\s*?(\d{1,3})\s*?,\s*?(\d{1,3})\s*?,\s*?(\d{1,3})\s*?.*?\)/i;if(e.test(t)){var n=function(t){return t.length<2&&(t="0"+t),t};t=t.replace(e,function(t,e,r,i){return e=n(parseInt(e).toString(16)),r=n(parseInt(r).toString(16)),i=n(parseInt(i).toString(16)),"#"+e+r+i})}return t}},i.prototype.size=function(t){if(t){var e=[0,12,14,16,18,24,32,48],n=[null,"smaller","small","medium","large","x-large","xx-large","-webkit-xxx-large"];if(/^\d+$/.test(t))return t;if(/^\d+?px$/.test(t)){if(t=parseInt(t),t&&!(0>t)){if(!this.opts.transsize)return t.toString();for(var r=e.length;r>=0;r--){if(0===r)return"1";if(t>=e[r])return r.toString()}return t?t.toString():void 0}}else{var i=n.indexOf(t);if(i>0)return this.opts.transsize?i.toString():e[i].toString()}}},i.prototype.px=function(t){return t?(t=parseInt(t),t?t.toString():void 0):void 0},i.prototype.convertStyle=function(t,e){if(e){var n=[],i=this,s=this.opts,o=function(e){if(e&&!e.ignore&&(e.section||e.extend&&e.extend.length>0)){var r={section:e.section};if(e.attr){if(!t.attr)return;switch(e.section){case"size":r.attr=i.size(t.attr[e.attr]);break;case"color":r.attr=i.color(t.attr[e.attr]);break;default:r.attr=t.attr[e.attr]}if(t.attr.style){var o;switch(e.section){case"size":o=t.attr.style["font-size"],o&&(o=i.size(o));break;case"color":o=t.attr.style.color,o&&(o=i.color(o));break;case"face":o=t.attr.style["font-face"]}o&&(r.attr=o)}if(!r.attr)return}else if("img"===e.section&&s.imagescale){var a,f;if(t.attr){if(a=i.px(t.attr.width),f=i.px(t.attr.height),t.attr.style){var c,l;c=i.px(t.attr.style.width),l=i.px(t.attr.style.height),c&&(a=c),l&&(f=l)}a&&f?r.attr=a+"x"+f:(a||f)&&(a?r.attr={width:a}:r.attr={height:f})}}e.data&&(r.data=t.attr[e.data]),n.push(r)}};if(t.attr&&t.attr.style){if("b"!==t.name&&"strong"!==t.name){var a=t.attr.style["font-weight"];("bold"===a||/^\d+$/.test(a)&&parseInt(a)>=700)&&o(r.maps.b)}if("center"!==t.name){var a=t.attr.style["text-align"];"center"!==a||s.noalign||o(r.maps.center)}}if("list"===e.section||"li"===e.section){if(s.nolist)return[]}else if("center"===e.section&&s.noalign)return[];if("extend"in e)for(var f=0;f<e.extend.length;f++){var c=e.extend[f];o(r.maps[c])}else o(e);return n}},i.prototype.convert=function(t){var n=new r;if(!t)return n;var i=this,s=function(t){for(var o=0;o<t.length;o++){var a=t[o];if(a instanceof e)if(a.name in r.maps){var f=!1,c=r.maps[a.name];if(c.ignore)continue;"newline"in c&&(f=c.newline,n.newline(c.newline));for(var l=i.convertStyle(a,c),h=0;h<l.length;h++)n.open(l[h].section,l[h].attr,l[h].data);a.content&&s(a.content.stack);for(var h=l.length-1;h>=0;h--)n.close(l[h].section);f&&n.newline()}else a.content&&s(a.content.stack);else"string"==typeof a&&(a=a.replace(/&nbsp;/gi," "),n.append(a))}};return s(t.stack),n},i.prototype.parse=function(t){return(new n).parse(t).strip().decode(!0)},i.prototype.feed=function(t){var e=this.parse(t),n=this.convert(e);return n},{HTMLTag:e,HTMLStack:n,BBCode:r,HTML2BBCode:i}});
