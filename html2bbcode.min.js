!function(t,e){"undefined"!=typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&"object"==typeof define.amd?define(e):this.html2bbcode=e()}(0,function(t){"use strict";function d(){this.name="",this.length=0}function v(){this.stack=[],this.length=0}var a,c,f,l;d.duptags=["div","span"],d.headingtags=["h1","h2","h3","h4","h5","h6"],d.selfendtags=["!doctype","meta","link","img","br"],d.newlinetags=["div","p","br","li","tr"].concat(d.headingtags),d.noemptytags=["head","style","script","span","a","font","color","size","face","strong","b","em","i","del","s","ins","u"],d.noemptyattrtags=["img"],d.prototype.findquoteend=function(t,e,n){var s=-1,i=e||0,r=t.length,o='"'===t[i];for(i++;i<r;)if("\\"===t[i])switch(t[++i]){case"u":i+=5;break;case"x":i+=3;break;default:i++}else{if(o&&'"'===t[i]||!o&&"'"===t[i]){s=i;break}if("\n"===t[i]&&!n)break;i++}return s},d.prototype.findscriptend=function(t,e){for(var n=-1,s=e||0,i=t.length,r=/(['"]|<\s*?\/\s*?script\s*?>)/gi;s<i;)if('"'===t[s]||"'"===t[s]){var o=this.findquoteend(t,s,!0);if(-1===o)break;s=o+1}else{r.lastIndex=s;var a=r.exec(t);if(!a||a.length<=0)break;if("<"===a[0][0]){n=r.lastIndex-a[0].length;break}s=r.lastIndex-1}return n},d.prototype.quote=function(t){if("'"===t[0]){for(var e='"',n=1,s=t.length-1,i=n;n<s;)if("\\"===t[n])switch(t[++n]){case"u":n+=5;break;case"x":n+=3;break;default:n++}else{if('"'===t[n]){e+=t.substr(i,n-i),e+='\\"',i=++n;break}n++}return i<s&&(e+=t.substr(i,s-i)),e+='"'}return t},d.prototype.parseStyle=function(t){for(var e=t.split(";"),n={},s=0,i=0;i<e.length;i++){var r=e[i].split(":");if(2<=r.length){var o;if(s++,"'"===(o=2<r.length?r.slice(1).join(":").trim():r[1].trim())[0]&&"'"===o[o.length-1])try{o=JSON.parse(this.quote(o))}catch(t){}n[r[0].trim().toLowerCase()]=o}}return 0<s?n:void 0},d.prototype.parseAttributes=function(t){for(var e=/\s/,n=0,s=(t=t.trim()).length,i=n,r=null,o=!1,a={},c=function(t,e){void 0===e&&(e=null),t=t.trim().toLowerCase(),a[t]=e};n<s;){if("="===t[n])r=t.substr(i,n-i),o=!1;else if(e.test(t[n]))r&&o?(c(r,t.substr(i,n-i)),o=!1,r=null):0<n-i&&(c(r=t.substr(i,n-i)),r=null),i=n+1;else if(r&&!o)if('"'===t[i=n]||"'"===t[n]){var f="'"===t[n];if(-1===(n=this.findquoteend(t,n)))break;var l=t.substr(i,n+1-i);f&&(l=this.quote(l));try{l=JSON.parse(l)}catch(t){}c(r,l),r=null,i=n+1}else o=!0;n++}if(i<s){var h=t.substr(i);r?c(r,h):c(h),r=null}var p=0;for(var u in a)p++;0<p&&(a.style&&(a.style=this.parseStyle(a.style)),this.attr=a)},d.prototype.parse=function(t){var e=0;if("<"!==t[e])throw new Error("not a tag");for(var n=t.length,s=/\s/;e<n;)if("<"===t[e])e++;else{if(">"===t[e])return this.length=e+1,this;if(!s.test(t[e]))break;e++}if(n<=e)return this.length=n,this;for(var i=e,r=!1;e<n&&!s.test(t[e]);){if(">"===t[e]){r=!0;break}if("/"===t[e])break;e++}if(n<=e)return this.length=e,this;if(this.name=t.substr(i,e-i).trim().toLowerCase(),0<this.name.length&&"/"===this.name[0])return this.length=e,this.name=this.name.substr(1),this.selfend=!0,this;if(0<=d.selfendtags.indexOf(this.name)&&(this.selfend=!0),!r){for(i=e;e<n&&">"!==t[e];)e++;if(n<=e)return this.length=e,this;if(0<e-i){var o=t.substr(i,e-i).trim(),a=o.length;0<a&&"/"===o[a-1]&&(this.selfend=!0,o=o.substr(0,a-1)),this.parseAttributes(o)}}if(e++,this.selfend)return this.length=e,this;var c=this,f=function(t){var e=(new v).parse(t);return c.content?c.content.append(e):c.content=e,e.length};if("script"===this.name){var l=this.findscriptend(t.substr(e));if(l<0)return this.length=n,this;this.content=new v;var h=t.substr(e,l);return this.content.length=l,this.content.stack=[h],e+=l,(i=t.indexOf(">",e))<0?(this.length=n,this):(this.length=i+1,this)}for(;e<n;){for(0,i=e;e<n&&s.test(t[e]);)e++;for(;e<n&&"<"!==t[e];)e++;var p=e;for(e++;e<n&&s.test(t[e]);)e++;if(n<=e)return this.content=(new v).parse(t.substr(i)),this.length=n,this;if(e<n&&"/"===t[e]){for(e++;e<n&&s.test(t[e]);)e++;if(n<=e)return e+=f(t.substr(i)),this.length=n,this;for(var u=e,g=!1;e<n&&!s.test(t[e]);){if(">"===t[e]){g=!0;break}e++}if(u<e){if(!g)for(;e<n&&">"!==t[e];)e++;t.substr(u,e-u).trim().toLowerCase();return e++,this.length=e,i<p&&f(t.substr(i,p-i)),this}}e=i+f(t.substr(i))}return this.length=e,this},v.prototype.parse=function(n){if(!n)return this;for(var t=0,e=n.length,s=0,i=/\s/,r=this,o=function(t,e){t<e&&r.push(n.substr(t,e-t))};t<e;)switch(n[t]){case"<":o(s,t);for(var a=t+1;a<e&&i.test(n[a]);)a++;if(a<e&&"/"===n[a])return this;var c=(new d).parse(n.substr(t));this.push(c),s=t+=c.length;break;case">":default:t++}return o(s,e),this},v.prototype.push=function(t){this.length+=t.length,this.stack.push(t)},v.prototype.pop=function(){return this.stack.pop()},v.prototype.append=function(t){this.stack=this.stack.concat(t.stack),this.length+=t.length},a=new RegExp("<\\s*?("+d.duptags.join("|")+")\\s*?>\\s*?<\\s*?\\1\\s*?>(((?!<\\s*?\\1\\s*?>)[\\S\\s])*?)<\\s*?/\\s*?\\1\\s*?>\\s*?<\\s*?/\\s*?\\1\\s*?>","ig"),c=new RegExp("(<\\s*?("+d.newlinetags.join("|")+")[^>]*?>)\\s+","ig"),f=new RegExp("\\s+(<\\s*?/\\s*?("+d.newlinetags.join("|")+")\\s*?>)","ig"),l=new RegExp("<\\s*?("+d.noemptytags.join("|")+")[^>]*?><\\s*?/\\s*?\\1\\s*?>","ig"),v.minify=function(t){var e,n=/<pre(\s.*?)?>/gi,s=/<\/pre>/gi,i=/\s{2,}/g,r="",o=-1;for(t=(t=(t=t.replace(l,"")).replace(c,"$1")).replace(f,"$1");n.exec(t);)o<0&&(o=0),r+=t.substr(o,n.lastIndex-o).replace(i," "),o=n.lastIndex,s.lastIndex=n.lastIndex,(e=s.exec(t))&&(n.lastIndex=s.lastIndex,r+=t.substr(o,e.index-o),o=e.index);for(0<=o&&(t=r+t.substr(o));a.test(t);)t=t.replace(a,"<$1>$2</$1>");return t=(t=t.replace(/>\s{2,}/g,"> ")).replace(/\s{2,}<\\s*?\//g," </")};var r={nbsp:" ",amp:"&",lt:"<",gt:">",quot:'"'};function p(){this.s="",this.weaknewline=!0,this.stack=[]}function e(t){this.opts=t||{}}return v.unescape=function(t,i){var e="&([a-zA-Z]+?|#[xX][\\da-fA-F]+?|#\\d+?);";if(new RegExp(e).test(t)){var n=new RegExp(e,"g");t=t.replace(n,function(t,e){if(e=e.toLowerCase(),i&&"nbsp"===e)return"&nbsp;";var n=r[e];if(n)return n;if("#"===e[0]){var s=0;if(s="x"==e[1]?parseInt(e.substr(2),16):parseInt(e.substr(1)))return String.fromCharCode(s)}return""})}return t},v.prototype.decode=function(t){for(var e=0;e<this.stack.length;e++){var n=this.stack[e];"string"==typeof n?this.stack[e]=v.unescape(n,t):n instanceof d&&n.content&&n.content.decode(t)}return this},v.prototype.dedup=function(){for(var t=0;t<this.stack.length;t++){var e=this.stack[t];if(e instanceof d&&e.content){if(0<=d.duptags.indexOf(e.name)&&!e.attr&&1===e.content.stack.length){var n=e.content.stack[0];if(n.name===e.name){this.stack[t]=n,t--;continue}}e.content.dedup()}}return this},v.prototype.strip=function(t,e){e||(e=!(t&&!e)||0<=d.newlinetags.indexOf(t.name));for(var n=/^\s*$/,s=0,i=!0,r=0;r<this.stack.length;r++){if((u=this.stack[r])instanceof d){if(i=!0,u.content){var o;if(s<=0)o=e;else{o=!1;for(var a=r-1;0<=a;a--){var c=this.stack[a];if(c instanceof d){o=0<=d.newlinetags.indexOf(c.name);break}if("string"!=typeof c||!n.test(c))break}}u.content.strip(u,o)}}else if("string"==typeof u&&n.test(u)&&i)continue;s++}i=!0;var f=[],l=0;for(r=0;r<this.stack.length;r++){if("string"==typeof(u=this.stack[r])&&n.test(u)&&e){if(i)continue;e=!1}else if(u instanceof d){if(i=!0,0<=d.noemptyattrtags.indexOf(u.name)){if(!u.attr)continue;var h=!1;for(var p in u.attr)if(u.attr[p]){h=!0;break}if(!h)continue}if(0<=d.noemptytags.indexOf(u.name)&&!u.content)continue;e=0<=d.newlinetags.indexOf(u.name)}else{if(e&&!(u=u.replace(/^\s+/g,"")))continue;u=u.replace(/\s+/g," "),e=i=!1}l++,f.push(u)}var u;if("string"==typeof(u=f[l-1])&&(2<=l&&n.test(u)?(f.splice(l-1,1),l--):/\S\s+$/.test(u)&&(f[l-1]=u.replace(/\s+$/,""))),!(l<=0&&t))return this.stack=f,this;delete t.content},v.prototype.showtree=function(t,e){t||(t=""),e||(e=0);for(var n=0;n<this.stack.length;n++){var s=this.stack[n];s instanceof d?(console.log(t,s.name,s.attr?JSON.stringify(s.attr):""),s.content&&s.content.showtree(t+"--",e+1)):"string"==typeof s&&console.log(t,JSON.stringify(s))}},p.maps={a:{section:"url",attr:"href"},img:{section:"img",data:"src",empty:!0},em:{section:"i"},i:{section:"i"},strong:{section:"b"},b:{section:"b"},del:{section:"s"},s:{section:"s"},ins:{section:"u"},u:{section:"u"},center:{section:"center"},ul:{section:"ul"},ol:{section:"ol"},li:{section:"li",newline:1},blockquote:{section:"quote"},code:{section:"code"},pre:{section:"code"},font:{extend:["color","face","size"]},span:{extend:["color","face","size"]},color:{section:"color",attr:"color"},size:{section:"size",attr:"size"},face:{section:"font",attr:"face"},h1:{section:"h1",newline:1},h2:{section:"h2",newline:1},h3:{section:"h3",newline:1},h4:{section:"h4",newline:1},h5:{section:"h5",newline:1},h6:{section:"h6",newline:1},p:{newline:1},br:{newline:2,empty:!0},table:{newline:1},tr:{newline:1},div:{newline:0},"!doctype":{ignore:!0},head:{ignore:!0},style:{ignore:!0},script:{ignore:!0},meta:{ignore:!0},link:{ignore:!0}},p.prototype.open=function(t,e,n){t&&(t instanceof Array?this.stack=this.stack.concat(t):this.stack.push({section:t,attr:e,data:n}))},p.prototype.append=function(t){this.solidify(),this._append(t)},p.prototype._append=function(t){t&&(this.s+=t,this.weaknewline=!1)},p.prototype.solidify=function(){var t;for(t=0;t<this.stack.length;t++){var e=this.stack[t],n=e.section,s=e.attr,i=e.data,r="["+n;if("string"==typeof s)r+="="+s;else for(var o in s)r+=" "+o+"="+s[o];r+="]",i&&(r+=i),this._append(r)}0<t&&(this.stack=[])},p.prototype.close=function(t){t&&(this.solidify(),this._append("[/"+t+"]"))},p.prototype.rollback=function(){this.stack=[]},p.prototype.newline=function(t){2===t?(this.append("\n"),this.weaknewline=!0):this.weaknewline||(this.append("\n"),this.weaknewline=!0)},p.prototype.toString=function(){return this.s},e.prototype.color=function(t){if(t){var e=/rgba?\s*?\(\s*?(\d{1,3})\s*?,\s*?(\d{1,3})\s*?,\s*?(\d{1,3})\s*?.*?\)/i;if(e.test(t)){var i=function(t){return t.length<2&&(t="0"+t),t};t=t.replace(e,function(t,e,n,s){return"#"+(e=i(parseInt(e).toString(16)))+(n=i(parseInt(n).toString(16)))+(s=i(parseInt(s).toString(16)))})}return t}},e.prototype.size=function(t){if(t){var e=[0,12,14,16,18,24,32,48];if(/^\d+$/.test(t))return t;if(!/^\d+?px$/.test(t)){var n=[null,"smaller","small","medium","large","x-large","xx-large","-webkit-xxx-large"].indexOf(t);return 0<n?this.opts.transsize?n.toString():e[n].toString():void 0}if((t=parseInt(t))&&!(t<0)){if(!this.opts.transsize)return t.toString();for(var s=e.length;0<=s;s--){if(0===s)return"1";if(t>=e[s])return s.toString()}return t?t.toString():void 0}}},e.prototype.px=function(t){if(t)return(t=parseInt(t))?t.toString():void 0},e.prototype.convertStyle=function(a,t){if(t){var c=[],f=this,l=this.opts,e=function(t){if(t&&!t.ignore&&(t.section||t.extend&&0<t.extend.length)){var e={section:t.section};if(t.attr){if(!a.attr)return;switch(t.section){case"size":e.attr=f.size(a.attr[t.attr]);break;case"color":e.attr=f.color(a.attr[t.attr]);break;default:e.attr=a.attr[t.attr]}if(a.attr.style){var n;switch(t.section){case"size":(n=a.attr.style["font-size"])&&(n=f.size(n));break;case"color":(n=a.attr.style.color)&&(n=f.color(n));break;case"font":n=a.attr.style["font-family"]}n&&(e.attr=n)}if(!e.attr)return}else if("img"===t.section&&l.imagescale){var s,i;if(a.attr){var r,o;if(s=f.px(a.attr.width),i=f.px(a.attr.height),a.attr.style)(r=f.px(a.attr.style.width))&&(s=r),(o=f.px(a.attr.style.height))&&(i=o);s&&i?e.attr=s+"x"+i:(s||i)&&(e.attr=s?{width:s}:{height:i})}}t.data&&(e.data=a.attr[t.data]),c.push(e)}};if(a.attr&&a.attr.style){var n;if("b"!==a.name&&"strong"!==a.name)("bold"===(n=a.attr.style["font-weight"])||/^\d+$/.test(n)&&700<=parseInt(n))&&e(p.maps.b);if("center"!==a.name)"center"!==(n=a.attr.style["text-align"])||l.noalign||e(p.maps.center);if("em"!==a.name&&"i"!==a.name)"italic"!==(n=a.attr.style["font-style"])&&"oblique"!==n||e(p.maps.i)}if("list"===t.section||"ul"===t.section||"ol"===t.section||"li"===t.section){if(l.nolist)return[]}else if("center"===t.section){if(l.noalign)return[]}else if(/^h\d+$/.test(t.section)&&l.noheadings){var s=[null,"32px","24px","19px","16px","14px","12px"],i=t.section.match(/^h(\d+)$/),r=parseInt(i[1]);return r<=0?[]:(s.length<=r&&(r=s.length),c.push({section:"size",attr:f.size(s[r])}),c)}if("extend"in t)for(var o=0;o<t.extend.length;o++){var h=t.extend[o];e(p.maps[h])}else e(t);return c}},e.prototype.convert=function(t){var c=new p;if(!t)return c;var f=this,l=function(t,e){for(var n=0;n<t.length;n++){var s=t[n];if(s instanceof d)if(s.name in p.maps){var i=0,r=p.maps[s.name];if(r.ignore)continue;if("newline"in r&&(i=r.newline,c.newline(r.newline)),!s.content&&!r.empty)continue;var o=f.convertStyle(s,r);c.open(o),s.content&&l(s.content.stack,i);for(var a=o.length-1;0<=a;a--)c.close(o[a].section);i&&c.newline()}else s.content&&l(s.content.stack);else"string"==typeof s&&c.append(s)}};return l(t.stack),c},e.prototype.parse=function(t){return(new v).parse(t).strip().dedup().decode()},e.prototype.feed=function(t){var e=this.parse(t);return this.opts.debug&&e.showtree(),this.convert(e)},{HTMLTag:d,HTMLStack:v,BBCode:p,HTML2BBCode:e}});
